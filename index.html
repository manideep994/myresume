import React, { useState, useEffect, useRef } from 'react';
import { Upload, X, Download, Eye, Search, FileText, File, Trash2, Edit3, Check, Plus, ChevronDown } from 'lucide-react';

// IndexedDB setup
const DB_NAME = 'ResumeVault';
const DB_VERSION = 1;
const STORE_NAME = 'documents';

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        store.createIndex('title', 'title', { unique: false });
        store.createIndex('tags', 'tags', { unique: false, multiEntry: true });
      }
    };
  });
};

const saveDocument = async (doc) => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.add(doc);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
};

const getAllDocuments = async () => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
};

const deleteDocument = async (id) => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.delete(id);
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
};

const updateDocument = async (id, updates) => {
  const db = await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const getRequest = store.get(id);
    
    getRequest.onsuccess = () => {
      const doc = getRequest.result;
      const updated = { ...doc, ...updates };
      const putRequest = store.put(updated);
      putRequest.onsuccess = () => resolve(updated);
      putRequest.onerror = () => reject(putRequest.error);
    };
    getRequest.onerror = () => reject(getRequest.error);
  });
};

// File type icon mapping
const getFileIcon = (fileType) => {
  if (fileType === 'application/pdf') return { color: '#FF3B30', label: 'PDF' };
  if (fileType.includes('word') || fileType.includes('document')) return { color: '#007AFF', label: 'DOC' };
  if (fileType === 'text/plain') return { color: '#34C759', label: 'TXT' };
  return { color: '#8E8E93', label: 'FILE' };
};

const DocumentCard = ({ doc, isSelected, onClick, onAction, onDownload, onView }) => {
  const [isEditing, setIsEditing] = useState(false);
  const [editTitle, setEditTitle] = useState(doc.title);
  const [editTags, setEditTags] = useState(doc.tags.join(', '));
  const fileIcon = getFileIcon(doc.fileType);

  const handleSave = async () => {
    const tags = editTags.split(',').map(t => t.trim()).filter(t => t);
    await onAction('update', doc.id, { title: editTitle, tags });
    setIsEditing(false);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSave();
    } else if (e.key === 'Escape') {
      setIsEditing(false);
      setEditTitle(doc.title);
      setEditTags(doc.tags.join(', '));
    }
  };

  const handleDragStart = (e) => {
    // Create blob from base64
    const base64ToBlob = (base64, mimeType) => {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: mimeType });
    };

    const blob = base64ToBlob(doc.fileData, doc.fileType);
    const url = URL.createObjectURL(blob);
    
    // Set drag data
    e.dataTransfer.effectAllowed = 'copy';
    e.dataTransfer.setData('DownloadURL', `${doc.fileType}:${doc.fileName}:${url}`);
    e.dataTransfer.setData('text/plain', doc.fileName);
  };

  return (
    <div 
      className={`doc-card ${isSelected ? 'selected' : ''}`}
      onClick={() => !isEditing && onClick(doc)}
      draggable={!isEditing}
      onDragStart={handleDragStart}
    >
      <div className="doc-icon-wrapper" style={{ backgroundColor: fileIcon.color + '15' }}>
        <div className="doc-icon-label" style={{ color: fileIcon.color }}>
          {fileIcon.label}
        </div>
      </div>
      
      {isEditing ? (
        <div className="doc-edit" onClick={(e) => e.stopPropagation()}>
          <input
            type="text"
            value={editTitle}
            onChange={(e) => setEditTitle(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Document name"
            autoFocus
          />
          <input
            type="text"
            value={editTags}
            onChange={(e) => setEditTags(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Tags (comma-separated)"
          />
          <div className="edit-buttons">
            <button onClick={handleSave} className="save-btn">
              <Check size={14} />
            </button>
            <button onClick={() => {
              setIsEditing(false);
              setEditTitle(doc.title);
              setEditTags(doc.tags.join(', '));
            }} className="cancel-edit-btn">
              <X size={14} />
            </button>
          </div>
        </div>
      ) : (
        <>
          <div className="doc-info">
            <div className="doc-title">{doc.title}</div>
            {doc.tags.length > 0 && (
              <div className="doc-tags">
                {doc.tags.map((tag, i) => (
                  <span key={i} className="mini-tag">{tag}</span>
                ))}
              </div>
            )}
            <div className="doc-date">{new Date(doc.uploadDate).toLocaleDateString()}</div>
          </div>
          
          <div className="doc-main-actions" onClick={(e) => e.stopPropagation()}>
            <button 
              onClick={() => onView(doc)}
              className="icon-btn view-icon"
              title="View"
            >
              <Eye size={14} />
            </button>
            <button 
              onClick={() => onDownload(doc)}
              className="icon-btn download-icon"
              title="Download"
            >
              <Download size={14} />
            </button>
            <button 
              onClick={() => setIsEditing(true)}
              className="icon-btn"
              title="Edit"
            >
              <Edit3 size={14} />
            </button>
          </div>

          <div className="doc-delete-action" onClick={(e) => e.stopPropagation()}>
            <button 
              onClick={() => onAction('delete', doc.id)}
              className="delete-btn"
              title="Delete"
            >
              <Trash2 size={14} />
              Delete
            </button>
          </div>
        </>
      )}
      
      {isSelected && <div className="selection-indicator" />}
    </div>
  );
};

export default function ResumeManager() {
  const [documents, setDocuments] = useState([]);
  const [filteredDocs, setFilteredDocs] = useState([]);
  const [selectedDocs, setSelectedDocs] = useState(new Set());
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedTags, setSelectedTags] = useState([]);
  const [isDragging, setIsDragging] = useState(false);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [viewingDoc, setViewingDoc] = useState(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    loadDocuments();
  }, []);

  useEffect(() => {
    filterDocuments();
  }, [documents, searchQuery, selectedTags]);

  const loadDocuments = async () => {
    const docs = await getAllDocuments();
    setDocuments(docs);
  };

  const filterDocuments = () => {
    let filtered = documents;

    if (searchQuery) {
      filtered = filtered.filter(doc =>
        doc.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        doc.tags.some(tag => tag.toLowerCase().includes(searchQuery.toLowerCase()))
      );
    }

    if (selectedTags.length > 0) {
      filtered = filtered.filter(doc =>
        selectedTags.every(tag => doc.tags.includes(tag))
      );
    }

    setFilteredDocs(filtered);
  };

  const handleFileUpload = async (files) => {
    for (const file of files) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64 = e.target.result.split(',')[1];
        
        const doc = {
          title: file.name.replace(/\.[^/.]+$/, ''),
          fileName: file.name,
          fileType: file.type,
          fileData: base64,
          tags: [],
          uploadDate: new Date().toISOString()
        };
        
        await saveDocument(doc);
        await loadDocuments();
      };
      reader.readAsDataURL(file);
    }
    setShowUploadModal(false);
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    setIsDragging(true);
  };

  const handleDragLeave = (e) => {
    if (e.currentTarget === e.target) {
      setIsDragging(false);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setIsDragging(false);
    const files = Array.from(e.dataTransfer.files).filter(file =>
      file.type === 'application/pdf' ||
      file.type.includes('word') ||
      file.type.includes('document') ||
      file.type === 'text/plain'
    );
    if (files.length > 0) {
      handleFileUpload(files);
    }
  };

  const handleFileSelect = (e) => {
    const files = Array.from(e.target.files);
    handleFileUpload(files);
  };

  const handleDocAction = async (action, id, data) => {
    if (action === 'delete') {
      await deleteDocument(id);
      setSelectedDocs(prev => {
        const next = new Set(prev);
        next.delete(id);
        return next;
      });
      await loadDocuments();
    } else if (action === 'update') {
      await updateDocument(id, data);
      await loadDocuments();
    }
  };

  const toggleSelection = (doc) => {
    setSelectedDocs(prev => {
      const next = new Set(prev);
      if (next.has(doc.id)) {
        next.delete(doc.id);
      } else {
        next.add(doc.id);
      }
      return next;
    });
  };

  const base64ToBlob = (base64, mimeType) => {
    try {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: mimeType });
    } catch (err) {
      console.error('Error converting base64 to blob:', err);
      return null;
    }
  };

  const handleDownload = () => {
    const docsToDownload = Array.from(selectedDocs);
    docsToDownload.forEach((id, index) => {
      const doc = documents.find(d => d.id === id);
      if (doc) {
        setTimeout(() => {
          const blob = base64ToBlob(doc.fileData, doc.fileType);
          if (blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = doc.fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
          }
        }, index * 200); // Stagger downloads by 200ms
      }
    });
  };

  const handleSingleDownload = (doc) => {
    const blob = base64ToBlob(doc.fileData, doc.fileType);
    if (blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = doc.fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }
  };

  const handleSingleCopy = async (doc) => {
    try {
      const blob = base64ToBlob(doc.fileData, doc.fileType);
      if (blob) {
        await navigator.clipboard.write([
          new ClipboardItem({ [blob.type]: blob })
        ]);
        return true;
      }
    } catch (err) {
      console.error('Copy failed:', err);
      return false;
    }
  };

  const handleView = (doc) => {
    setViewingDoc(doc);
  };

  const handleCopy = async () => {
    if (selectedDocs.size === 0) return;
    
    try {
      const items = [];
      for (const id of selectedDocs) {
        const doc = documents.find(d => d.id === id);
        if (doc) {
          const blob = base64ToBlob(doc.fileData, doc.fileType);
          if (blob) {
            items.push(new ClipboardItem({ [blob.type]: blob }));
          }
        }
      }
      
      if (items.length > 0) {
        await navigator.clipboard.write(items);
        // Visual feedback
        const btn = document.querySelector('.copy-btn');
        if (btn) {
          const originalText = btn.innerHTML;
          btn.innerHTML = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        }
      }
    } catch (err) {
      console.error('Copy failed:', err);
      alert('Copy failed. Your browser may not support this feature.');
    }
  };

  const toggleTag = (tag) => {
    setSelectedTags(prev =>
      prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]
    );
  };

  const selectAll = () => {
    setSelectedDocs(new Set(filteredDocs.map(d => d.id)));
  };

  const deselectAll = () => {
    setSelectedDocs(new Set());
  };

  const allTags = [...new Set(documents.flatMap(doc => doc.tags))].sort();

  return (
    <div 
      className="app"
      onDragOver={handleDragOver}
      onDragLeave={handleDragLeave}
      onDrop={handleDrop}
    >
      <style>{`
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
          background: linear-gradient(135deg, #f0f9f4 0%, #e8f5ed 100%);
          color: #1d1d1f;
          -webkit-font-smoothing: antialiased;
        }

        .app {
          min-height: 100vh;
          padding: 20px;
        }

        .header {
          max-width: 1200px;
          margin: 0 auto 24px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 20px;
        }

        .title-section {
          text-align: center;
          flex: 1;
        }

        .logo-container {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 12px;
          margin-bottom: 4px;
        }

        .logo-icon {
          filter: drop-shadow(0 2px 8px rgba(52, 199, 89, 0.3));
        }

        .title-section h1 {
          font-size: 32px;
          font-weight: 600;
          letter-spacing: -0.5px;
          color: #1d1d1f;
          margin: 0;
        }

        .doc-count {
          font-size: 14px;
          color: #86868b;
        }

        .search-bar {
          position: relative;
          width: 240px;
        }

        .search-bar input {
          width: 100%;
          padding: 8px 12px 8px 36px;
          border: none;
          background: #fff;
          border-radius: 10px;
          font-size: 14px;
          color: #1d1d1f;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          transition: all 0.2s;
        }

        .search-bar input:focus {
          outline: none;
          box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.2);
        }

        .search-icon {
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          color: #86868b;
          pointer-events: none;
        }

        .btn {
          padding: 8px 16px;
          border: none;
          border-radius: 10px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all 0.2s;
          background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
          color: white;
          box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .btn:hover {
          background: linear-gradient(135deg, #30d158 0%, #28a745 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
        }

        .btn:active {
          transform: translateY(0);
        }

        .toolbar {
          max-width: 1200px;
          margin: 0 auto 20px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 12px;
          padding: 12px 16px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .selection-info {
          display: flex;
          gap: 12px;
          align-items: center;
          font-size: 14px;
          color: #86868b;
        }

        .select-actions {
          display: flex;
          gap: 8px;
        }

        .select-btn {
          padding: 4px 12px;
          border: none;
          background: transparent;
          color: #34c759;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
          border-radius: 6px;
          transition: background 0.2s;
        }

        .select-btn:hover {
          background: rgba(52, 199, 89, 0.1);
        }

        .action-buttons {
          display: flex;
          gap: 8px;
        }

        .action-btn {
          padding: 6px 14px;
          border: none;
          background: white;
          border: 1px solid #d2d2d7;
          color: #1d1d1f;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
          border-radius: 8px;
          display: flex;
          align-items: center;
          gap: 6px;
          transition: all 0.2s;
        }

        .action-btn:hover:not(:disabled) {
          background: #f0f9f4;
          border-color: #34c759;
        }

        .action-btn:disabled {
          opacity: 0.4;
          cursor: not-allowed;
        }

        .action-btn.primary {
          background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
          color: white;
          border-color: #34c759;
          box-shadow: 0 2px 6px rgba(52, 199, 89, 0.25);
        }

        .action-btn.primary:hover:not(:disabled) {
          background: linear-gradient(135deg, #30d158 0%, #28a745 100%);
          box-shadow: 0 3px 10px rgba(52, 199, 89, 0.35);
        }

        .tag-filter {
          display: flex;
          gap: 8px;
          align-items: center;
          flex-wrap: wrap;
        }

        .filter-tag {
          padding: 4px 10px;
          background: white;
          border: 1px solid #d2d2d7;
          border-radius: 12px;
          font-size: 12px;
          color: #1d1d1f;
          cursor: pointer;
          transition: all 0.2s;
        }

        .filter-tag:hover {
          background: #f0f9f4;
          border-color: #34c759;
        }

        .filter-tag.active {
          background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
          color: white;
          border-color: #34c759;
          box-shadow: 0 2px 6px rgba(52, 199, 89, 0.25);
        }

        .document-grid {
          max-width: 1200px;
          margin: 0 auto;
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 16px;
        }

        .doc-card {
          background: white;
          border-radius: 12px;
          padding: 16px;
          cursor: pointer;
          transition: all 0.2s;
          position: relative;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          display: flex;
          flex-direction: column;
          gap: 12px;
          border: 2px solid transparent;
        }

        .doc-card:hover {
          box-shadow: 0 8px 24px rgba(52, 199, 89, 0.15);
          transform: translateY(-4px);
          border-color: rgba(52, 199, 89, 0.3);
        }

        .doc-card.selected {
          border-color: #34c759;
          box-shadow: 0 4px 16px rgba(52, 199, 89, 0.25);
        }

        .doc-icon-wrapper {
          width: 100%;
          aspect-ratio: 1;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .doc-icon-label {
          font-size: 20px;
          font-weight: 700;
          letter-spacing: -0.5px;
        }

        .doc-info {
          flex: 1;
        }

        .doc-title {
          font-size: 13px;
          font-weight: 500;
          color: #1d1d1f;
          margin-bottom: 6px;
          line-height: 1.3;
          word-break: break-word;
        }

        .doc-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          margin-bottom: 6px;
        }

        .mini-tag {
          font-size: 10px;
          padding: 2px 6px;
          background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(48, 209, 88, 0.1) 100%);
          border-radius: 4px;
          color: #34c759;
          font-weight: 500;
        }

        .doc-date {
          font-size: 11px;
          color: #86868b;
        }

        .doc-main-actions {
          display: flex;
          gap: 6px;
          justify-content: center;
          padding: 8px 0;
          border-top: 1px solid #f0f0f0;
        }

        .doc-delete-action {
          padding-top: 8px;
          border-top: 1px solid #f0f0f0;
        }

        .delete-btn {
          width: 100%;
          padding: 8px;
          border: none;
          background: transparent;
          color: #ff3b30;
          font-size: 13px;
          font-weight: 500;
          border-radius: 6px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          transition: all 0.2s;
        }

        .delete-btn:hover {
          background: #ffe9e7;
        }

        .icon-btn {
          width: 32px;
          height: 32px;
          border: none;
          background: transparent;
          border-radius: 8px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #86868b;
          transition: all 0.2s;
          border: 1px solid #e8e8ed;
        }

        .icon-btn:hover {
          background: #f0f9f4;
          color: #34c759;
          border-color: #34c759;
        }

        .icon-btn.view-icon:hover {
          background: #e8f5ed;
          color: #34c759;
        }

        .icon-btn.download-icon:hover {
          background: #e8f5ed;
          color: #30d158;
        }

        .preview-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1001;
          padding: 20px;
        }

        .preview-content {
          background: white;
          border-radius: 16px;
          max-width: 900px;
          width: 100%;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .preview-header {
          padding: 20px 24px;
          border-bottom: 1px solid #f0f0f0;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          gap: 16px;
        }

        .preview-title h2 {
          font-size: 24px;
          font-weight: 600;
          color: #1d1d1f;
          margin-bottom: 8px;
        }

        .preview-meta {
          display: flex;
          align-items: center;
          gap: 12px;
          flex-wrap: wrap;
        }

        .preview-tags {
          display: flex;
          gap: 4px;
        }

        .preview-date {
          font-size: 13px;
          color: #86868b;
        }

        .close-preview-btn {
          background: transparent;
          border: none;
          cursor: pointer;
          color: #86868b;
          padding: 4px;
          border-radius: 6px;
          transition: all 0.2s;
        }

        .close-preview-btn:hover {
          background: #f5f5f7;
          color: #1d1d1f;
        }

        .preview-body {
          flex: 1;
          overflow: auto;
          background: #f5f5f7;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }

        .preview-frame {
          width: 100%;
          height: 600px;
          border: none;
          border-radius: 8px;
          background: white;
        }

        .preview-placeholder {
          text-align: center;
          color: #86868b;
        }

        .preview-placeholder p {
          margin-top: 16px;
          font-size: 15px;
        }

        .preview-hint {
          font-size: 13px !important;
          color: #b8b8b8 !important;
          margin-top: 8px !important;
        }

        .preview-footer {
          padding: 16px 24px;
          border-top: 1px solid #f0f0f0;
          display: flex;
          justify-content: flex-end;
        }

        .preview-action-btn {
          padding: 10px 20px;
          background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 15px;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .preview-action-btn:hover {
          background: linear-gradient(135deg, #30d158 0%, #28a745 100%);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(52, 199, 89, 0.4);
        }

        .doc-edit {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .doc-edit input {
          width: 100%;
          padding: 6px 8px;
          border: 1px solid #d2d2d7;
          border-radius: 6px;
          font-size: 12px;
          font-family: inherit;
          background: #f0f9f4;
        }

        .doc-edit input:focus {
          outline: none;
          border-color: #34c759;
          background: white;
        }

        .edit-buttons {
          display: flex;
          gap: 4px;
          justify-content: flex-end;
        }

        .save-btn, .cancel-edit-btn {
          width: 28px;
          height: 28px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .save-btn {
          background: #34c759;
          color: white;
        }

        .save-btn:hover {
          background: #28a745;
        }

        .cancel-edit-btn {
          background: #f5f5f7;
          color: #86868b;
        }

        .cancel-edit-btn:hover {
          background: #e8e8ed;
        }

        .selection-indicator {
          position: absolute;
          top: 8px;
          right: 8px;
          width: 24px;
          height: 24px;
          background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 8px rgba(52, 199, 89, 0.4);
        }

        .selection-indicator::after {
          content: 'âœ“';
          color: white;
          font-size: 14px;
          font-weight: 700;
        }

        .upload-modal {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.4);
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          padding: 20px;
        }

        .modal-content {
          background: white;
          border-radius: 16px;
          padding: 32px;
          max-width: 480px;
          width: 100%;
          text-align: center;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
          font-size: 24px;
          font-weight: 600;
          margin-bottom: 12px;
          color: #1d1d1f;
        }

        .modal-content p {
          font-size: 14px;
          color: #86868b;
          margin-bottom: 24px;
        }

        .drop-zone {
          border: 2px dashed #d2d2d7;
          border-radius: 12px;
          padding: 48px 24px;
          margin-bottom: 24px;
          transition: all 0.2s;
        }

        .drop-zone.dragging {
          border-color: #34c759;
          background: rgba(52, 199, 89, 0.05);
        }

        .drop-icon {
          width: 56px;
          height: 56px;
          margin: 0 auto 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #f5f5f7;
          border-radius: 50%;
          color: #86868b;
        }

        .drop-text {
          font-size: 15px;
          color: #1d1d1f;
          margin-bottom: 8px;
          font-weight: 500;
        }

        .drop-hint {
          font-size: 13px;
          color: #86868b;
        }

        .modal-actions {
          display: flex;
          gap: 12px;
        }

        .modal-btn {
          flex: 1;
          padding: 12px;
          border: none;
          border-radius: 10px;
          font-size: 15px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
        }

        .modal-btn.cancel {
          background: #f5f5f7;
          color: #1d1d1f;
        }

        .modal-btn.cancel:hover {
          background: #e8e8ed;
        }

        .modal-btn.primary {
          background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
          color: white;
          box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .modal-btn.primary:hover {
          background: linear-gradient(135deg, #30d158 0%, #28a745 100%);
          box-shadow: 0 3px 12px rgba(52, 199, 89, 0.4);
        }

        .empty-state {
          max-width: 480px;
          margin: 80px auto;
          text-align: center;
        }

        .empty-icon {
          width: 80px;
          height: 80px;
          margin: 0 auto 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(48, 209, 88, 0.1) 100%);
          border-radius: 50%;
          color: #34c759;
        }

        .empty-state h2 {
          font-size: 28px;
          font-weight: 600;
          margin-bottom: 12px;
          color: #1d1d1f;
        }

        .empty-state p {
          font-size: 15px;
          color: #86868b;
          line-height: 1.5;
          margin-bottom: 24px;
        }

        .drag-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(135deg, rgba(52, 199, 89, 0.95) 0%, rgba(48, 209, 88, 0.95) 100%);
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 999;
          pointer-events: none;
        }

        .drag-overlay-content {
          text-align: center;
          color: white;
        }

        .drag-overlay-icon {
          width: 120px;
          height: 120px;
          margin: 0 auto 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(255,255,255,0.2);
          border-radius: 50%;
        }

        .drag-overlay h2 {
          font-size: 32px;
          font-weight: 600;
          margin-bottom: 8px;
        }

        .drag-overlay p {
          font-size: 17px;
          opacity: 0.9;
        }

        input[type="file"] {
          display: none;
        }

        @media (max-width: 768px) {
          .document-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
          }

          .header {
            flex-direction: column;
            align-items: flex-start;
          }

          .toolbar {
            flex-direction: column;
            align-items: flex-start;
          }
        }
      `}</style>

      {isDragging && (
        <div className="drag-overlay">
          <div className="drag-overlay-content">
            <div className="drag-overlay-icon">
              <Upload size={56} strokeWidth={1.5} />
            </div>
            <h2>Drop to upload</h2>
            <p>Release files to add them to your vault</p>
          </div>
        </div>
      )}

      <div className="header">
        <div className="search-bar">
          <Search className="search-icon" size={16} />
          <input
            type="text"
            placeholder="Search"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
        
        <div className="title-section">
          <div className="logo-container">
            <svg className="logo-icon" width="32" height="32" viewBox="0 0 32 32" fill="none">
              <rect width="32" height="32" rx="8" fill="url(#gradient1)" />
              <path d="M16 8L20 12H18V20H14V12H12L16 8Z" fill="white" opacity="0.9" />
              <path d="M10 22H22V24H10V22Z" fill="white" opacity="0.9" />
              <circle cx="16" cy="16" r="2" fill="white" opacity="0.6" />
              <defs>
                <linearGradient id="gradient1" x1="0" y1="0" x2="32" y2="32">
                  <stop offset="0%" stopColor="#34c759" />
                  <stop offset="100%" stopColor="#30d158" />
                </linearGradient>
              </defs>
            </svg>
            <h1>Sync Doc</h1>
          </div>
          <div className="doc-count">
            {filteredDocs.length} {filteredDocs.length === 1 ? 'document' : 'documents'}
          </div>
        </div>

        <button className="btn" onClick={() => setShowUploadModal(true)}>
          <Plus size={18} />
          Add
        </button>
      </div>

      {allTags.length > 0 && (
        <div className="toolbar">
          <div className="tag-filter">
            {allTags.map(tag => (
              <span
                key={tag}
                className={`filter-tag ${selectedTags.includes(tag) ? 'active' : ''}`}
                onClick={() => toggleTag(tag)}
              >
                {tag}
              </span>
            ))}
          </div>
        </div>
      )}

      {filteredDocs.length === 0 && documents.length === 0 ? (
        <div className="empty-state">
          <div className="empty-icon">
            <FileText size={40} strokeWidth={1.5} />
          </div>
          <h2>No documents</h2>
          <p>Upload your resumes, cover letters, and other documents to get started.</p>
          <button className="btn" onClick={() => setShowUploadModal(true)}>
            <Plus size={18} />
            Add Document
          </button>
        </div>
      ) : filteredDocs.length === 0 ? (
        <div className="empty-state">
          <div className="empty-icon">
            <Search size={40} strokeWidth={1.5} />
          </div>
          <h2>No results</h2>
          <p>Try adjusting your search or filters</p>
        </div>
      ) : (
        <div className="document-grid">
          {filteredDocs.map(doc => (
            <DocumentCard
              key={doc.id}
              doc={doc}
              isSelected={selectedDocs.has(doc.id)}
              onClick={toggleSelection}
              onAction={handleDocAction}
              onDownload={handleSingleDownload}
              onView={handleView}
            />
          ))}
        </div>
      )}

      {showUploadModal && (
        <div className="upload-modal" onClick={() => setShowUploadModal(false)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <h2>Add Documents</h2>
            <p>Upload PDF, Word, or text files</p>
            <div className={`drop-zone ${isDragging ? 'dragging' : ''}`}>
              <div className="drop-icon">
                <Upload size={28} strokeWidth={1.5} />
              </div>
              <div className="drop-text">Drag and drop files here</div>
              <div className="drop-hint">or click browse to choose files</div>
            </div>
            <div className="modal-actions">
              <button className="modal-btn cancel" onClick={() => setShowUploadModal(false)}>
                Cancel
              </button>
              <button className="modal-btn primary" onClick={() => fileInputRef.current?.click()}>
                Browse
              </button>
            </div>
            <input
              ref={fileInputRef}
              type="file"
              multiple
              accept=".pdf,.doc,.docx,.txt"
              onChange={handleFileSelect}
            />
          </div>
        </div>
      )}

      {viewingDoc && (
        <div className="preview-modal" onClick={() => setViewingDoc(null)}>
          <div className="preview-content" onClick={(e) => e.stopPropagation()}>
            <div className="preview-header">
              <div className="preview-title">
                <h2>{viewingDoc.title}</h2>
                <div className="preview-meta">
                  {viewingDoc.tags.length > 0 && (
                    <div className="preview-tags">
                      {viewingDoc.tags.map((tag, i) => (
                        <span key={i} className="mini-tag">{tag}</span>
                      ))}
                    </div>
                  )}
                  <span className="preview-date">{new Date(viewingDoc.uploadDate).toLocaleDateString()}</span>
                </div>
              </div>
              <button onClick={() => setViewingDoc(null)} className="close-preview-btn">
                <X size={24} />
              </button>
            </div>
            <div className="preview-body">
              {viewingDoc.fileType === 'application/pdf' ? (
                <iframe 
                  src={URL.createObjectURL(base64ToBlob(viewingDoc.fileData, viewingDoc.fileType))} 
                  className="preview-frame"
                  title={viewingDoc.title}
                />
              ) : viewingDoc.fileType === 'text/plain' ? (
                <iframe 
                  src={URL.createObjectURL(base64ToBlob(viewingDoc.fileData, viewingDoc.fileType))} 
                  className="preview-frame"
                  title={viewingDoc.title}
                />
              ) : (
                <div className="preview-placeholder">
                  <FileText size={64} strokeWidth={1} />
                  <p>Preview not available for this file type</p>
                  <p className="preview-hint">Click download to view the document</p>
                </div>
              )}
            </div>
            <div className="preview-footer">
              <button onClick={() => handleSingleDownload(viewingDoc)} className="preview-action-btn">
                <Download size={18} />
                Download
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
